name: Build and Deploy Franklin Site

on:
  push:
    branches:
      - source

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Setup Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1'

      # --- ä¿®æ­£ç‚¹ 1 ---
      # Franklin ã® "v1" ç³»ã‚’æŒ‡å®šã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
      - name: Install dependencies
        run: julia -e 'using Pkg; Pkg.add(Pkg.PackageSpec(name="Franklin", version="1")); Pkg.add("NodeJS")'
      
      - name: Install highlight.js ğŸ’¡
        run: julia -e 'using NodeJS; run(`$(npm_cmd()) install highlight.js`)'

      - name: Build and Deploy ğŸš€
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          julia -e '
            using Franklin
            using NodeJS
            
            Franklin.optimize(clear=true)
            
            # --- ä¿®æ­£ç‚¹ 2 ---
            # é–¢æ•°åã‚’ "deploy" ã«æˆ»ã—ã¾ã™ (v1ç³»ã§ã¯ã“ã¡ã‚‰ãŒæ¨å¥¨)
            Franklin.deploy(
              gh_repo="git@github.com:Akita-Kosuke/akita-kosuke.github.io.git",
              branch="master",
              ssh=true
            )
          '