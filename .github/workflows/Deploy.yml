name: Build and Deploy Franklin Site

on:
  push:
    branches:
      - source  # â˜…ãƒˆãƒªã‚¬ãƒ¼ã¯ "source" ãƒ–ãƒ©ãƒ³ãƒã§ã™

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰(sourceãƒ–ãƒ©ãƒ³ãƒ)ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      # 2. Juliaã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1'

      # 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(Franklinã¨NodeJS)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # Project.toml ã«åŸºã¥ã„ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
      - name: Install dependencies
        run: julia -e 'using Pkg; Pkg.activate("."); Pkg.instantiate()'
      
      # 4. ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
      - name: Build and Deploy ğŸš€
        env:
          # â˜…ã‚¹ãƒ†ãƒƒãƒ—4ã§è¨­å®šã—ãŸç§˜å¯†éµ(åˆéµ)ã‚’ä½¿ã„ã¾ã™
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }} 
        run: |
          # SSHã‚­ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Franklin.jl ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤é–¢æ•°ã‚’å®Ÿè¡Œ
          julia -e '
            using Franklin
            using NodeJS
            
            # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ (ã“ã“ã§ã‚¯ãƒªãƒ¼ãƒ³ãª sitemap.xml ãŒä½œã‚‰ã‚Œã¾ã™)
            optimize(clear=true, sitemap=true, feed=true)
            
            # â˜…"master" ãƒ–ãƒ©ãƒ³ãƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
            deploy(
              gh_repo="git@github.com:Akita-Kosuke/akita-kosuke.github.io.git",
              branch="master", 
              ssh=true
            )
          '
